<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Account - Tindi Tech</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/css pracs.css">
</head>

<body style="display:flex; justify-content:center; align-items:center; min-height:100vh; background:#f0f2f5;">

    <div class="card" style="width:100%; max-width:450px; padding:30px;">
        <div style="text-align:center; margin-bottom:20px;">
            <img src="assets/img/logo.png" style="height:60px;" alt="Tindi Tech">
            <h2>Verify Account</h2>
            <p class="text-muted">Enter the codes sent to your Email & Phone</p>
        </div>

        <form id="verify-form">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="ver-email" class="form-input" readonly style="background:#f9f9f9;">
            </div>

            <div class="form-group">
                <label>Email Code (Check Inbox/Spam)</label>
                <input type="text" id="email-otp" class="form-input" placeholder="6-digit code">
            </div>

            <div class="form-group" id="phone-otp-group">
                <label>Phone Code (SMS)</label>
                <input type="text" id="phone-otp" class="form-input" placeholder="6-digit code">
            </div>

            <button type="submit" class="btn btn-primary btn-block">Verify</button>

            <div style="margin-top:15px; text-align:center;">
                <a href="#" onclick="resendCodes()" style="font-size:0.9em;">Resend Codes</a>
            </div>
        </form>
    </div>

    <script src="assets/js/site-api.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const email = params.get('email');
        const phone = params.get('phone');

        if (email) document.getElementById('ver-email').value = email;
        if (!phone || phone === 'null') document.getElementById('phone-otp-group').style.display = 'none';

        document.getElementById('verify-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailOtp = document.getElementById('email-otp').value;
            const phoneOtp = document.getElementById('phone-otp').value;

            if (!emailOtp) return window.showToast('Email OTP required', 'error');

            try {
                const res = await fetch(`${window.API_URL}/verify-account`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('ver-email').value,
                        email_otp: emailOtp,
                        phone_otp: phone ? phoneOtp : null
                    })
                });
                const json = await res.json();

                if (json.success) {
                    window.showToast('Verification Successful!', 'success');
                    
                    // Auto-login if token provided
                    if (json.token) {
                        // Save token and user info
                        localStorage.setItem('token', json.token);
                        localStorage.setItem('user_role', json.user.role);
                        localStorage.setItem('user_name', json.user.username);
                        
                        // Redirect based on role
                        setTimeout(() => {
                            const role = json.user.role;
                            if (role === 'admin' || role === 'super_admin') {
                                window.location.href = 'Admin.html';
                            } else {
                                window.location.href = 'My Orders.html';
                            }
                        }, 1000);
                    } else {
                        // Fallback to login page if no token
                        setTimeout(() => window.location.href = 'login.html', 1500);
                    }
                } else {
                    window.showToast(json.error, 'error');
                }
            } catch (e) {
                window.showToast('Connection failed', 'error');
            }
        });

        async function resendCodes() {
            const emailVal = document.getElementById('ver-email').value;
            if (!emailVal) return;
            try {
                const res = await fetch(`${window.API_URL}/resend-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: emailVal })
                });
                window.showToast('Codes resent! Check your inbox/phone.', 'success');
            } catch (e) { window.showToast('Failed to resend', 'error'); }
        }
    </script>

</body>

</html>